!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Jose=t():e.Jose=t()}(window,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=1)}([function(e,t,r){"use strict";r.r(t),r.d(t,"importPublicKey",(function(){return s})),r.d(t,"importPrivateKey",(function(){return u})),r.d(t,"importEcPublicKey",(function(){return c})),r.d(t,"importEcPrivateKey",(function(){return y})),r.d(t,"importRsaPublicKey",(function(){return f})),r.d(t,"importRsaPrivateKey",(function(){return p})),r.d(t,"isString",(function(){return l})),r.d(t,"arrayish",(function(){return h})),r.d(t,"convertRsaKey",(function(){return d})),r.d(t,"arrayFromString",(function(){return g})),r.d(t,"arrayFromUtf8String",(function(){return m})),r.d(t,"stringFromArray",(function(){return v})),r.d(t,"utf8StringFromArray",(function(){return S})),r.d(t,"stripLeadingZeros",(function(){return w})),r.d(t,"arrayFromInt32",(function(){return b})),r.d(t,"arrayBufferConcat",(function(){return A})),r.d(t,"sha256",(function(){return k})),r.d(t,"isCryptoKey",(function(){return C})),r.d(t,"Base64Url",(function(){return E}));var n=r(2),i=r(1);function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var o=new n.a,s=function(e,t){switch(t){case"RS256":case"RS384":case"RS512":case"PS256":case"PS384":case"PS512":return f(e,t);case"ES256":case"ES384":case"ES512":return c(e,t);default:throw Error("unsupported algorithm: "+t)}},u=function(e,t){switch(t){case"RS256":case"RS384":case"RS512":case"PS256":case"PS384":case"PS512":return p(e,t);case"ES256":case"ES384":case"ES512":return y(e,t);default:throw Error("unsupported algorithm: "+t)}},c=function(e,t){var r=o.getSignConfig(t),n=o.getKeyUsageByAlg(t);return i.Jose.crypto.subtle.importKey("jwk",e,r.id,!1,[n.publicKey])},y=function(e,t){var r=o.getSignConfig(t),n=o.getKeyUsageByAlg(t);return i.Jose.crypto.subtle.importKey("jwk",e,r.id,!1,[n.privateKey])},f=function(e,t){var r,n,a=o.getKeyUsageByAlg(t);if("wrapKey"===a.publicKey)e.alg||(e.alg=t),r=d(e,["n","e"]),n=o.getCryptoConfig(t);else{var s={};for(var u in e)e.hasOwnProperty(u)&&(s[u]=e[u]);!s.alg&&t&&(s.alg=t),n=o.getSignConfig(s.alg),(r=d(s,["n","e"])).ext=!0}return i.Jose.crypto.subtle.importKey("jwk",r,n.id,!1,[a.publicKey])},p=function(e,t){var r,n,a=o.getKeyUsageByAlg(t);if("unwrapKey"===a.privateKey)e.alg||(e.alg=t),r=d(e,["n","e","d","p","q","dp","dq","qi"]),n=o.getCryptoConfig(t);else{var s={};for(var u in e)e.hasOwnProperty(u)&&(s[u]=e[u]);n=o.getSignConfig(t),!s.alg&&t&&(s.alg=t),(r=d(s,["n","e","d","p","q","dp","dq","qi"])).ext=!0}return i.Jose.crypto.subtle.importKey("jwk",r,n.id,!1,[a.privateKey])},l=function(e){return"string"==typeof e||e instanceof String},h=function(e){return e instanceof Array?e:e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):void o.assert(!1,"arrayish: invalid input")},d=function(e,t){var r,n={},i=[];t.map((function(t){void 0===e[t]&&i.push(t)})),i.length>0&&o.assert(!1,"convertRsaKey: Was expecting "+i.join()),void 0!==e.kty&&o.assert("RSA"===e.kty,"convertRsaKey: expecting rsaKey['kty'] to be 'RSA'"),n.kty="RSA";try{o.getSignConfig(e.alg),r=e.alg}catch(t){try{o.getCryptoConfig(e.alg),r=e.alg}catch(e){o.assert(r,"convertRsaKey: expecting rsaKey['alg'] to have a valid value")}}n.alg=r;for(var a=function(e){return parseInt(e,16)},s=0;s<t.length;s++){var u=t[s],c=e[u],y=new E;if("e"===u)"number"==typeof c&&(c=y.encodeArray(w(b(c))));else if(/^([0-9a-fA-F]{2}:)+[0-9a-fA-F]{2}$/.test(c)){var f=c.split(":").map(a);c=y.encodeArray(w(f))}else"string"!=typeof c&&o.assert(!1,"convertRsaKey: expecting rsaKey['"+u+"'] to be a string");n[u]=c}return n},g=function(e){o.assert(l(e),"arrayFromString: invalid input");var t=e.split("").map((function(e){return e.charCodeAt(0)}));return new Uint8Array(t)},m=function(e){return o.assert(l(e),"arrayFromUtf8String: invalid input"),e=unescape(encodeURIComponent(e)),g(e)},v=function(e){e=h(e);for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t},S=function(e){o.assert(e instanceof ArrayBuffer,"utf8StringFromArray: invalid input");var t=v(e);return decodeURIComponent(escape(t))},w=function(e){e instanceof ArrayBuffer&&(e=new Uint8Array(e));for(var t=!0,r=[],n=0;n<e.length;n++)t&&0===e[n]||(t=!1,r.push(e[n]));return r},b=function(e){o.assert("number"==typeof e,"arrayFromInt32: invalid input"),o.assert(e==e|0,"arrayFromInt32: out of range");for(var t=new Uint8Array(new Uint32Array([e]).buffer),r=new Uint8Array(4),n=0;n<4;n++)r[n]=t[3-n];return r.buffer};function A(){for(var e=[],t=0,r=0;r<arguments.length;r++)e.push(h(arguments[r])),t+=e[r].length;var n=new Uint8Array(t),i=0;for(r=0;r<arguments.length;r++)for(var a=0;a<e[r].length;a++)n[i++]=e[r][a];return o.assert(i===t,"arrayBufferConcat: unexpected offset"),n}var k=function(e){return i.Jose.crypto.subtle.digest({name:"SHA-256"},g(e)).then((function(e){return(new E).encodeArray(e)}))},C=function(e){return"CryptoKey"===e.constructor.name||!!e.hasOwnProperty("algorithm")},E=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,n;return t=e,(r=[{key:"encode",value:function(e){return o.assert(l(e),"Base64Url.encode: invalid input"),btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}},{key:"encodeArray",value:function(e){return this.encode(v(e))}},{key:"decode",value:function(e){return o.assert(l(e),"Base64Url.decode: invalid input"),atob(e.replace(/-/g,"+").replace(/_/g,"/"))}},{key:"decodeArray",value:function(e){return o.assert(l(e),"Base64Url.decodeArray: invalid input"),g(this.decode(e))}}])&&a(t.prototype,r),n&&a(t,n),e}()},function(e,t,r){"use strict";r.r(t),function(e){r.d(t,"crypto",(function(){return n})),r.d(t,"Utils",(function(){return f})),r.d(t,"setCrypto",(function(){return h})),r.d(t,"Jose",(function(){return d})),r.d(t,"JoseJWE",(function(){return p})),r.d(t,"JoseJWS",(function(){return l})),r.d(t,"caniuse",(function(){return g}));var n,i=r(0),a=r(3),o=r(4),s=r(5),u=r(6),c=r(2);function y(e){return(y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}r.d(t,"WebCryptographer",(function(){return c.a}));var f=i,p={Encrypter:a.a,Decrypter:o.a},l={Signer:s.a,Verifier:u.a},h=function(e){n=e};"undefined"!=typeof window&&void 0!==window.crypto&&(h(window.crypto),n.subtle||(n.subtle=n.webkitSubtle));var d={JoseJWS:l,JoseJWE:p,WebCryptographer:c.a,crypto:n,Utils:f};t.default={Jose:d,WebCryptographer:c.a};var g=function(){var t=!0;t=(t=(t=(t=t&&"function"==typeof Promise)&&"function"==typeof Promise.reject)&&"function"==typeof Promise.prototype.then)&&"function"==typeof Promise.all;var r=window||e;return t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t&&"object"===y(r.crypto))&&"object"===y(r.crypto.subtle))&&"function"==typeof r.crypto.getRandomValues)&&"function"==typeof r.crypto.subtle.importKey)&&"function"==typeof r.crypto.subtle.generateKey)&&"function"==typeof r.crypto.subtle.exportKey)&&"function"==typeof r.crypto.subtle.wrapKey)&&"function"==typeof r.crypto.subtle.unwrapKey)&&"function"==typeof r.crypto.subtle.encrypt)&&"function"==typeof r.crypto.subtle.decrypt)&&"function"==typeof r.crypto.subtle.sign)&&"function"==typeof ArrayBuffer)&&("function"==typeof Uint8Array||"object"===("undefined"==typeof Uint8Array?"undefined":y(Uint8Array))))&&("function"==typeof Uint32Array||"object"===("undefined"==typeof Uint32Array?"undefined":y(Uint32Array))))&&"object"===("undefined"==typeof JSON?"undefined":y(JSON)))&&"function"==typeof JSON.parse)&&"function"==typeof JSON.stringify)&&"function"==typeof atob)&&"function"==typeof btoa}}.call(this,r(7))},function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var n=r(0),i=r(1);function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.setKeyEncryptionAlgorithm("RSA-OAEP"),this.setContentEncryptionAlgorithm("A256GCM"),this.setContentSignAlgorithm("RS256")}var t,r,o;return t=e,(r=[{key:"setKeyEncryptionAlgorithm",value:function(e){this.keyEncryption=this.getCryptoConfig(e)}},{key:"getKeyEncryptionAlgorithm",value:function(){return this.keyEncryption.jweName}},{key:"setContentEncryptionAlgorithm",value:function(e){this.content_encryption=this.getCryptoConfig(e)}},{key:"getContentEncryptionAlgorithm",value:function(){return this.content_encryption.jweName}},{key:"setContentSignAlgorithm",value:function(e){this.content_sign=this.getSignConfig(e)}},{key:"getContentSignAlgorithm",value:function(){return this.content_sign.jwa_name}},{key:"createIV",value:function(){var e=new Uint8Array(new Array(this.content_encryption.iv_bytes));return i.Jose.crypto.getRandomValues(e)}},{key:"createCek",value:function(){var e=this.getCekWorkaround(this.content_encryption);return i.Jose.crypto.subtle.generateKey(e.id,!0,e.enc_op)}},{key:"wrapCek",value:function(e,t){return i.Jose.crypto.subtle.wrapKey("raw",e,t,this.keyEncryption.id)}},{key:"unwrapCek",value:function(e,t){var r=this.getCekWorkaround(this.content_encryption),n=this.content_encryption.specific_cekBytes>0,a=this.keyEncryption.id;return i.Jose.crypto.subtle.unwrapKey("raw",e,t,a,r.id,n,r.dec_op)}},{key:"getCekWorkaround",value:function(e){var t=e.specific_cekBytes;if(t){if(16===t)return{id:{name:"AES-CBC",length:128},enc_op:["encrypt"],dec_op:["decrypt"]};if(32===t)return{id:{name:"AES-CBC",length:256},enc_op:["encrypt"],dec_op:["decrypt"]};if(64===t)return{id:{name:"HMAC",hash:{name:"SHA-256"}},enc_op:["sign"],dec_op:["verify"]};if(128===t)return{id:{name:"HMAC",hash:{name:"SHA-384"}},enc_op:["sign"],dec_op:["verify"]};this.assert(!1,"getCekWorkaround: invalid len")}return{id:e.id,enc_op:["encrypt"],dec_op:["decrypt"]}}},{key:"encrypt",value:function(e,t,r,n){var a=this,o=this.content_encryption;if(e.length!==o.iv_bytes)return Promise.reject(Error("invalid IV length"));if(o.auth.aead){var s=o.auth.tagBytes,u={name:o.id.name,iv:e,additionalData:t,tagLength:8*s};return r.then((function(e){return i.Jose.crypto.subtle.encrypt(u,e,n).then((function(e){var t=e.byteLength-s;return{cipher:e.slice(0,t),tag:e.slice(t)}}))}))}var c=this.splitKey(o,r,["encrypt"]),y=c[0],f=c[1].then((function(t){var r={name:o.id.name,iv:e};return i.Jose.crypto.subtle.encrypt(r,t,n)})),p=f.then((function(r){return a.truncatedMac(o,y,t,e,r)}));return Promise.all([f,p]).then((function(e){return{cipher:e[0],tag:e[1]}}))}},{key:"compare",value:function(e,t,r,n){return this.assert(r instanceof Uint8Array,"compare: invalid input"),this.assert(n instanceof Uint8Array,"compare: invalid input"),t.then((function(t){var a=i.Jose.crypto.subtle.sign(e.auth.id,t,r),o=i.Jose.crypto.subtle.sign(e.auth.id,t,n);return Promise.all([a,o]).then((function(e){var t=new Uint8Array(e[0]),r=new Uint8Array(e[1]);if(t.length!==r.length)throw new Error("compare failed");for(var n=0;n<t.length;n++)if(t[n]!==r[n])throw new Error("compare failed");return Promise.resolve(null)}))}))}},{key:"decrypt",value:function(e,t,r,a,o){var s=this;if(r.length!==this.content_encryption.iv_bytes)return Promise.reject(Error("decryptCiphertext: invalid IV"));var u=this.content_encryption;if(u.auth.aead){var c={name:u.id.name,iv:r,additionalData:t,tagLength:8*u.auth.tagBytes};return e.then((function(e){var t=n.arrayBufferConcat(a,o);return i.Jose.crypto.subtle.decrypt(c,e,t)}))}var y=this.splitKey(u,e,["decrypt"]),f=y[0],p=y[1],l=this.truncatedMac(u,f,t,r,a);return Promise.all([p,l]).then((function(e){var t=e[0],n=e[1];return s.compare(u,f,new Uint8Array(n),o).then((function(){var e={name:u.id.name,iv:r};return i.Jose.crypto.subtle.decrypt(e,t,a)})).catch((function(){return Promise.reject(Error("decryptCiphertext: MAC failed."))}))}))}},{key:"sign",value:function(e,t,r){var a=this.content_sign;return e.alg&&(a=this.getSignConfig(e.alg)),r.then((function(r){var o=new n.Base64Url;return i.Jose.crypto.subtle.sign(a.id,r,n.arrayFromString(o.encode(JSON.stringify(e))+"."+o.encodeArray(t)))}))}},{key:"verify",value:function(e,t,r,a,o){var s=this.content_sign;return a.then((function(a){return i.Jose.crypto.subtle.verify(s.id,a,r,n.arrayFromString(e+"."+t)).then((function(e){return{kid:o,verified:e}}))}))}},{key:"keyId",value:function(e){return n.sha256(e.n+"+"+e.d)}},{key:"splitKey",value:function(e,t,r){var n=t.then((function(e){return i.Jose.crypto.subtle.exportKey("raw",e)}));return[n.then((function(t){if(8*t.byteLength!==e.id.length+8*e.auth.key_bytes)return Promise.reject(Error("encryptPlainText: incorrect cek length"));var r=t.slice(0,e.auth.key_bytes);return i.Jose.crypto.subtle.importKey("raw",r,e.auth.id,!1,["sign"])})),n.then((function(t){if(8*t.byteLength!==e.id.length+8*e.auth.key_bytes)return Promise.reject(Error("encryptPlainText: incorrect cek length"));var n=t.slice(e.auth.key_bytes);return i.Jose.crypto.subtle.importKey("raw",n,e.id,!1,r)}))]}},{key:"getCryptoConfig",value:function(e){switch(e){case"RSA-OAEP":return{jweName:"RSA-OAEP",id:{name:"RSA-OAEP",hash:{name:"SHA-1"}}};case"RSA-OAEP-256":return{jweName:"RSA-OAEP-256",id:{name:"RSA-OAEP",hash:{name:"SHA-256"}}};case"A128KW":return{jweName:"A128KW",id:{name:"AES-KW",length:128}};case"A256KW":return{jweName:"A256KW",id:{name:"AES-KW",length:256}};case"dir":return{jweName:"dir"};case"A128CBC-HS256":return{jweName:"A128CBC-HS256",id:{name:"AES-CBC",length:128},iv_bytes:16,specific_cekBytes:32,auth:{key_bytes:16,id:{name:"HMAC",hash:{name:"SHA-256"}},truncated_bytes:16}};case"A256CBC-HS512":return{jweName:"A256CBC-HS512",id:{name:"AES-CBC",length:256},iv_bytes:16,specific_cekBytes:64,auth:{key_bytes:32,id:{name:"HMAC",hash:{name:"SHA-512"}},truncated_bytes:32}};case"A128GCM":return{jweName:"A128GCM",id:{name:"AES-GCM",length:128},iv_bytes:12,auth:{aead:!0,tagBytes:16}};case"A256GCM":return{jweName:"A256GCM",id:{name:"AES-GCM",length:256},iv_bytes:12,auth:{aead:!0,tagBytes:16}};default:throw Error("unsupported algorithm: "+e)}}},{key:"truncatedMac",value:function(e,t,r,a,o){return t.then((function(t){var s=new Uint8Array(n.arrayFromInt32(8*r.length)),u=new Uint8Array(8);u.set(s,4);var c=n.arrayBufferConcat(r,a,o,u);return i.Jose.crypto.subtle.sign(e.auth.id,t,c).then((function(t){return t.slice(0,e.auth.truncated_bytes)}))}))}},{key:"getSignConfig",value:function(e){switch(e){case"RS256":return{jwa_name:"RS256",id:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}}};case"RS384":return{jwa_name:"RS384",id:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}}};case"RS512":return{jwa_name:"RS512",id:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}}};case"PS256":return{jwa_name:"PS256",id:{name:"RSA-PSS",hash:{name:"SHA-256"},saltLength:20}};case"PS384":return{jwa_name:"PS384",id:{name:"RSA-PSS",hash:{name:"SHA-384"},saltLength:20}};case"PS512":return{jwa_name:"PS512",id:{name:"RSA-PSS",hash:{name:"SHA-512"},saltLength:20}};case"HS256":return{jwa_name:"HS256",id:{name:"HMAC",hash:{name:"SHA-256"}}};case"HS384":return{jwa_name:"HS384",id:{name:"HMAC",hash:{name:"SHA-384"}}};case"HS512":return{jwa_name:"HS512",id:{name:"HMAC",hash:{name:"SHA-512"}}};case"ES256":return{jwa_name:"ES256",id:{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}}};case"ES384":return{jwa_name:"ES384",id:{name:"ECDSA",namedCurve:"P-384",hash:{name:"SHA-384"}}};case"ES512":return{jwa_name:"ES512",id:{name:"ECDSA",namedCurve:"P-521",hash:{name:"SHA-512"}}};default:throw Error("unsupported algorithm: "+e)}}},{key:"getKeyUsageByAlg",value:function(e){switch(e){case"RS256":case"RS384":case"RS512":case"PS256":case"PS384":case"PS512":case"HS256":case"HS384":case"HS512":case"ES256":case"ES384":case"ES512":case"ES256K":return{publicKey:"verify",privateKey:"sign"};case"RSA-OAEP":case"RSA-OAEP-256":case"A128KW":case"A256KW":return{publicKey:"wrapKey",privateKey:"unwrapKey"};default:throw Error("unsupported algorithm: "+e)}}},{key:"assert",value:function(e,t){if(!e)throw new Error(t)}}])&&a(t.prototype,r),o&&a(t,o),e}()},function(e,t,r){"use strict";r.d(t,"a",(function(){return a}));var n=r(0);function i(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var a=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cryptographer=t,this.keyPromise=r,this.userHeaders={}}var t,r,a;return t=e,(r=[{key:"addHeader",value:function(e,t){this.userHeaders[e]=t}},{key:"encrypt",value:function(e){var t,r;"dir"===this.cryptographer.getKeyEncryptionAlgorithm()?(t=Promise.resolve(this.keyPromise),r=[]):(t=this.cryptographer.createCek(),r=Promise.all([this.keyPromise,t]).then(function(e){var t=e[0],r=e[1];return this.cryptographer.wrapCek(r,t)}.bind(this)));var i=function(e,t){var r={};for(var i in this.userHeaders)r[i]=this.userHeaders[i];r.alg=this.cryptographer.getKeyEncryptionAlgorithm(),r.enc=this.cryptographer.getContentEncryptionAlgorithm();var a=(new n.Base64Url).encode(JSON.stringify(r)),o=this.cryptographer.createIV(),s=n.arrayFromString(a);return"string"==typeof t&&(t=n.arrayFromUtf8String(t)),this.cryptographer.encrypt(o,s,e,t).then((function(e){return e.header=a,e.iv=o,e}))}.bind(this,t,e)();return Promise.all([r,i]).then((function(e){var t=e[0],r=e[1],i=new n.Base64Url;return r.header+"."+i.encodeArray(t)+"."+i.encodeArray(r.iv)+"."+i.encodeArray(r.cipher)+"."+i.encodeArray(r.tag)}))}}])&&i(t.prototype,r),a&&i(t,a),e}()},function(e,t,r){"use strict";r.d(t,"a",(function(){return a}));var n=r(0);function i(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var a=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cryptographer=t,this.keyPromise=r,this.headers={},this.base64UrlEncoder=new n.Base64Url}var t,r,a;return t=e,(r=[{key:"getHeaders",value:function(){return this.headers}},{key:"decrypt",value:function(e){var t,r=e.split(".");if(5!==r.length)return Promise.reject(Error("decrypt: invalid input"));if(this.headers=JSON.parse(this.base64UrlEncoder.decode(r[0])),!this.headers.alg)return Promise.reject(Error("decrypt: missing alg"));if(!this.headers.enc)return Promise.reject(Error("decrypt: missing enc"));if(this.cryptographer.setKeyEncryptionAlgorithm(this.headers.alg),this.cryptographer.setContentEncryptionAlgorithm(this.headers.enc),this.headers.crit)return Promise.reject(Error("decrypt: crit is not supported"));if("dir"===this.headers.alg)t=Promise.resolve(this.keyPromise);else{var i=this.base64UrlEncoder.decodeArray(r[1]);t=this.keyPromise.then(function(e){return this.cryptographer.unwrapCek(i,e)}.bind(this))}return this.cryptographer.decrypt(t,n.arrayFromString(r[0]),this.base64UrlEncoder.decodeArray(r[2]),this.base64UrlEncoder.decodeArray(r[3]),this.base64UrlEncoder.decodeArray(r[4])).then(n.utf8StringFromArray)}}])&&i(t.prototype,r),a&&i(t,a),e}()},function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));var n=r(0);function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function o(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}var s=function(){function e(t){i(this,e),this.cryptographer=t,this.keyPromises={},this.waiting_kid=0,this.headers={},this.signer_aads={},this.signer_headers={}}return o(e,[{key:"addSigner",value:function(e,t,r,i){var a,o,s,u=this;n.isCryptoKey(e)?a=new Promise((function(t){t(e)})):(o=r&&r.alg?r.alg:u.cryptographer.getContentSignAlgorithm(),a=n.importPrivateKey(e,o,"sign"));if(t)s=new Promise((function(e){e(t)}));else{if(n.isCryptoKey(e))throw new Error("keyId is a mandatory argument when the key is a CryptoKey");s=this.cryptographer.keyId(e)}return u.waiting_kid++,s.then((function(e){return u.keyPromises[e]=a,u.waiting_kid--,r&&(u.signer_aads[e]=r),i&&(u.signer_headers[e]=i),e}))}},{key:"addSignature",value:function(e,t,r){if(n.isString(e)&&(e=JSON.parse(e)),e.payload&&n.isString(e.payload)&&e.protected&&n.isString(e.protected)&&e.header&&e.header instanceof Object&&e.signature&&n.isString(e.signature))return this.sign(u.fromObject(e),t,r);throw new Error("JWS is not a valid JWS object")}},{key:"sign",value:function(e,t,r){var i=this,a=[];if(0===Object.keys(i.keyPromises).length)throw new Error("No signers defined. At least one is required to sign the JWS.");if(i.waiting_kid)throw new Error("still generating key IDs");function o(e,t,r,a,o){var s;if(t||(t={}),t.alg||(t.alg=i.cryptographer.getContentSignAlgorithm(),t.typ="JWT"),t.kid||(t.kid=o),n.isString(e))s=n.arrayFromUtf8String(e);else try{s=n.arrayish(e)}catch(t){if(e instanceof u)s=n.arrayFromString((new n.Base64Url).decode(e.payload));else{if(!(e instanceof Object))throw new Error("cannot sign this message");s=n.arrayFromUtf8String(JSON.stringify(e))}}return i.cryptographer.sign(t,s,a).then((function(n){var i=new u(t,r,s,n);return e instanceof u?(delete i.payload,e.signatures?e.signatures.push(i):e.signatures=[i],e):i}))}for(var s in i.keyPromises)i.keyPromises.hasOwnProperty(s)&&a.push(s);return function e(t,r,n,a,s){if(s.length){var u=s.shift(),c=o(t,i.signer_aads[u]||r,i.signer_headers[u]||n,a[u],u);return s.length&&(c=c.then((function(t){return e(t,null,null,a,s)}))),c}}(e,t,r,i.keyPromises,a)}}]),e}(),u=function(){function e(t,r,a,o){i(this,e),this.header=r;var s=new n.Base64Url;this.payload=s.encodeArray(a),o&&(this.signature=s.encodeArray(o)),this.protected=s.encode(JSON.stringify(t))}return o(e,[{key:"fromObject",value:function(t){var r=new e(t.protected,t.header,t.payload,null);return r.signature=t.signature,r.signatures=t.signatures,r}},{key:"JsonSerialize",value:function(){return JSON.stringify(this)}},{key:"CompactSerialize",value:function(){return this.protected+"."+this.payload+"."+this.signature}}]),e}()},function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var n=r(0);function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var o=function(){function e(t,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var o,s,u,c,y,f,p;if(this.cryptographer=t,o=t.getContentSignAlgorithm(),n.isString(r))if(s=/^([0-9a-z_-]+)\.([0-9a-z_-]+)\.([0-9a-z_-]+)$/i.exec(r)){if(4!==s.length)throw new Error("wrong JWS compact serialization format");r={protected:s[1],payload:s[2],signature:s[3]}}else r=JSON.parse(r);else if("object"!==i(r))throw new Error("data format not supported");u=r.protected,c=r.header,y=r.payload,(f=r.signatures instanceof Array?r.signatures.slice(0):[]).forEach((function(e){e.aad=e.protected,e.protected=JSON.parse((new n.Base64Url).decode(e.protected))})),this.aad=u,p=(new n.Base64Url).decode(u);try{p=JSON.parse(p)}catch(e){}if(!p&&!c)throw new Error("at least one header is required");if(!p.alg)throw new Error("'alg' is a mandatory header");if(p.alg!==o)throw new Error("the alg header '"+p.alg+"' doesn't match the requested algorithm '"+o+"'");if(p&&p.typ&&"JWT"!==p.typ)throw new Error("typ '"+p.typ+"' not supported");r.signature&&f.unshift({aad:u,protected:p,header:c,signature:r.signature}),this.signatures=[];for(var l=0;l<f.length;l++)this.signatures[l]=JSON.parse(JSON.stringify(f[l])),this.signatures[l].signature=n.arrayFromString((new n.Base64Url).decode(f[l].signature));this.payload=y,this.keyPromises={},this.waiting_kid=0,a&&(this.keyfinder=a)}var t,r,o;return t=e,(r=[{key:"addRecipient",value:function(e,t,r){var i,a,o=this;if(a=n.isCryptoKey(e)?new Promise((function(t){t(e)})):n.importPublicKey(e,r||o.cryptographer.getContentSignAlgorithm(),"verify"),t)i=new Promise((function(e){e(t)}));else{if(n.isCryptoKey(e))throw new Error("keyId is a mandatory argument when the key is a CryptoKey");console.log("it's unsafe to omit a keyId"),i=this.cryptographer.keyId(e)}return o.waiting_kid++,i.then((function(e){return o.keyPromises[e]=a,o.waiting_kid--,e}))}},{key:"verify",value:function(){var e=this,t=e.signatures,r=e.keyPromises,i=e.keyfinder,a=[];if(!(i||Object.keys(e.keyPromises).length>0))throw new Error("No recipients defined. At least one is required to verify the JWS.");if(e.waiting_kid)throw new Error("still generating key IDs");return t.forEach((function(t){var o=t.protected.kid;i&&(r[o]=i(o)),a.push(e.cryptographer.verify(t.aad,e.payload,t.signature,r[o],o).then((function(t){return t.verified&&(t.payload=(new n.Base64Url).decode(e.payload)),t})))})),Promise.all(a)}}])&&a(t.prototype,r),o&&a(t,o),e}()},function(e,t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"===("undefined"==typeof window?"undefined":r(window))&&(n=window)}e.exports=n}])}));